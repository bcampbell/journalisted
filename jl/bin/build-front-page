#!/usr/bin/php
<?php
/* 
 * build-front-page
 *
 * Run from cron daily to rebuild the offline-generated
 * snippets on the front page.
 *
 */

$short_opts = '';
$long_opts = array('verbose', 'help', 'dryrun' );

chdir(dirname($_SERVER['SCRIPT_FILENAME']));
require_once "../conf/general";
require_once "../../phplib/phpcli.php";
require_once '../../phplib/db.php';
require_once '../../phplib/debug.php';
/* require_once '../../phplib/utility.php'; */
/* require_once '../../phplib/person.php'; */
/* require_once "../phplib/misc.php"; */
require_once "../phplib/cache.php";
require_once "../phplib/frontpage.php";

$cacheid = 'frontpage';

$switches = $options[0];
$args = $options[1];
$verbose = 0;
$dryrun = 0;
foreach( $switches as $switch) {
	if ($switch[0]=='--verbose') $verbose = 1;
	if ($switch[0]=='--dryrun') $dryrun = 1;
	if ($switch[0]=='--help') {
		Usage();
        exit;
    }
}

db_connect();


if( $verbose )
	print "building front page...\n";

ob_start();
$start = getmicrotime();
cache_gen_annotated( $cacheid, 'frontpage_emit' );
$end = getmicrotime();
$content = ob_get_contents();
ob_end_clean();

if( $dryrun )
    print $content;
else
    cache_set( $cacheid, $content );

if( $verbose )
	printf( "done (in %.3fs)\n", $end-$start );


/************/


function Usage()
{
?>

Rebuild cached portions of Journalisted front page.

Usage: build-front-page [--verbose]

--help      Display this help message
--verbose   output progress to stdout
--dryrun    output html stdout instead of loading into htmlcache table
<?
}



